<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SxmTransformer.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jsxm-maven-plugin</a> &gt; <a href="index.html" class="el_package">org.jsxm.maven.plugin.jsxmtool.generation</a> &gt; <span class="el_source">SxmTransformer.java</span></div><h1>SxmTransformer.java</h1><pre class="source lang-java linenums">/**
 * JSXM Maven PLugin CONFIDENTIAL
 * 
 *  __________________
 * 
 * Unpublished Copyright Â© 2012-2013 Konstantinos Margaritis, 
 * All Rights Reserved.
 * 
 * NOTICE:  All information contained herein is, and remains the property of Konstantinos Margaritis . 
 *
 * The intellectual and technical concepts contained herein are proprietary to the owner
 * Konstantinos Margaritis and may be covered by U.S and Foreign Patents, patents in process, 
 * and are protected by trade secret or copyright law. Dissemination of this information or 
 * reproduction of this material is strictly forbidden unless prior written permission is
 * obtained from Konstantinos Margaritis. Access to the source code contained herein is hereby 
 * forbidden to anyone except the owner.Confidentiality and Non-disclosure agreements 
 * explicitly covering such access.
 *
 * The copyright notice above does not evidence any actual or intended publication 
 * or disclosure  of  this source code, which includes information that is confidential 
 * and/or proprietary, and is a trade secret, of  Konstantinos Margaritis. ANY REPRODUCTION, 
 * MODIFICATION, DISTRIBUTION, PUBLIC  PERFORMANCE, OR PUBLIC DISPLAY OF OR THROUGH USE  OF 
 * THIS  SOURCE CODE  WITHOUT  THE EXPRESS WRITTEN CONSENT OF Konstantinos Margaritis IS STRICTLY PROHIBITED, 
 * AND IN VIOLATION OF APPLICABLE LAWS AND INTERNATIONAL TREATIES.  THE RECEIPT OR POSSESSION OF  
 * THIS SOURCE CODE AND/OR RELATED INFORMATION DOES NOT CONVEY OR IMPLY ANY RIGHTS  
 * TO REPRODUCE, DISCLOSE OR DISTRIBUTE ITS CONTENTS, OR TO MANUFACTURE, USE, OR SELL 
 * ANYTHING THAT IT  MAY DESCRIBE, IN WHOLE OR IN PART.  
 * 
 */
package org.jsxm.maven.plugin.jsxmtool.generation;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.util.LinkedList;
import java.util.List;

import org.jsxm.jsxmcore.core.AbstractDefsxmFactory;
import org.jsxm.jsxmcore.exceptions.DefinitionNotFoundException;
import org.jsxm.jsxmcore.testcasegenerators.JUnitTestTransformation;
import org.jsxm.maven.plugin.jsxmtool.core.Specification;
import org.jsxm.maven.plugin.jsxmtool.utilities.JSXMUtils;
import org.jsxm.maven.plugin.jsxmtool.utilities.SxmFileUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * @author Konstantinos Margaritis
 * 
 */
<span class="fc" id="L53">public class SxmTransformer {</span>
    
<span class="fc" id="L55">    private static final Object TRANSFORM_LOCK = new Object();</span>
    private static final String SPACE = &quot;           &quot;;
    
<span class="fc" id="L58">    private final JUnitTestTransformation testTransf = new JUnitTestTransformation();</span>
<span class="fc" id="L59">    private final Logger logger = (Logger) LoggerFactory.getLogger(this.getClass());</span>
<span class="fc" id="L60">    private boolean testAllowed = false;</span>
    
    public boolean isTestAllowed() {
<span class="nc" id="L63">        return testAllowed;</span>
    }
    
    public void setTestAllowed(boolean testAllowed) {
<span class="fc" id="L67">        this.testAllowed = testAllowed;</span>
<span class="fc" id="L68">    }</span>
    
    /**
     * Transform.
     * 
     * @param p
     *            the p
     * @throws DefinitionNotFoundException
     *             the definition not found exception
     */
    public void transform(Specification p) throws DefinitionNotFoundException {
        
<span class="fc" id="L80">        final String classUnderTestParameter = p.getClassName() + &quot;Adapter&quot;;</span>
<span class="fc" id="L81">        final String testingClassParameter = p.getClassName() + &quot;JsxmAdapterTest&quot;;</span>
<span class="fc" id="L82">        final String xmlFileName = p.getTestsDirectory() + p.getClassName() + &quot;_test.xml&quot;;</span>
<span class="fc" id="L83">        final String compAdapterClass = p.getClassName() + &quot;Adapter.java&quot;;</span>
<span class="fc" id="L84">        final File compAdapterClassFile = new File(p.getTestAdaptersDirectory() + compAdapterClass);</span>
        
<span class="fc" id="L86">        String packageTestDir = p.getJunitMavenTestPath() + p.getPackageTestDir();</span>
        
<span class="pc bpc" id="L88" title="1 of 2 branches missed.">        if (compAdapterClassFile.exists()) {</span>
<span class="fc" id="L89">            SxmFileUtils.copyDirectory(new File(p.getTestAdaptersDirectory()), new File(packageTestDir), &quot;.java&quot;);</span>
            
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">            if (p.getMode().equals(&quot;verbose&quot;)) {</span>
<span class="nc" id="L92">                logger.info(&quot;verbose mode on&quot;);</span>
            }
<span class="fc" id="L94">            AbstractDefsxmFactory.setDeffilePath(p.getSpecificationDirectory());</span>
            
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">            if (p.getPackageTest() == null) {</span>
<span class="nc" id="L97">                logger.debug(&quot;package null. trying external implementation&quot;);</span>
<span class="nc" id="L98">                prepareExternalImplementation(compAdapterClass, classUnderTestParameter, testingClassParameter,</span>
                        xmlFileName, p);
            } else {
<span class="fc" id="L101">                logger.debug(&quot;implementation found&quot;);</span>
<span class="fc" id="L102">                String specificationTestPackageDir = p.getJunitMavenTestPath() + JSXMUtils.replaceDotWithSlash(p.getPackageTest());</span>
<span class="fc" id="L103">                logger.debug(&quot;{} {} {} {} {}&quot;, p.getPackageTest(), classUnderTestParameter, testingClassParameter,</span>
                        xmlFileName, specificationTestPackageDir);
<span class="fc" id="L105">                setParameters(p.getPackageTest(), classUnderTestParameter, testingClassParameter, xmlFileName,</span>
                        specificationTestPackageDir, true);
            }
            
            try {
<span class="fc" id="L110">                logger.debug(&quot;&quot; + testTransf);</span>
<span class="fc" id="L111">                testTransf.transform();</span>
<span class="nc" id="L112">            } catch (DefinitionNotFoundException e) {</span>
<span class="nc" id="L113">                logger.error(&quot;DefinitionNotFoundException&quot;, e);</span>
<span class="fc" id="L114">            }</span>
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">            if (p.getMode().equals(&quot;verbose&quot;)) {</span>
<span class="nc" id="L116">                synchronized (TRANSFORM_LOCK) {</span>
<span class="nc" id="L117">                    logger.info(&quot;Path = &quot; + p.getJunitDirectory());</span>
<span class="nc" id="L118">                    logger.info(&quot;Class name  = &quot; + classUnderTestParameter);</span>
<span class="nc" id="L119">                    logger.info(&quot;Junit class  = &quot; + testingClassParameter);</span>
<span class="nc" id="L120">                    logger.info(&quot;Xml file name  = &quot; + xmlFileName);</span>
<span class="nc" id="L121">                }</span>
            } else {
<span class="fc" id="L123">                synchronized (TRANSFORM_LOCK) {</span>
<span class="fc" id="L124">                    logger.info(SPACE + &quot;--&gt;Class under test : &quot; + classUnderTestParameter + &quot;&lt;--&quot;);</span>
<span class="fc" id="L125">                    logger.info(SPACE + &quot;--&gt;JUnit test class : &quot; + testingClassParameter + &quot;&lt;--&quot;);</span>
<span class="fc" id="L126">                    logger.info(SPACE + &quot;###&quot; + p.getClassName() + &quot; tests transformed successfully###\n&quot;);</span>
<span class="fc" id="L127">                    setTestAllowed(true);</span>
<span class="pc" id="L128">                }</span>
            }
        } else {
<span class="nc" id="L131">            synchronized (TRANSFORM_LOCK) {</span>
<span class="nc" id="L132">                logger.info(SPACE + &quot;--&gt;Class under test : Adapter is missing &lt;--&quot;);</span>
<span class="nc" id="L133">                logger.info(SPACE + &quot;--&gt;JUnit test class :       ----         &lt;--&quot;);</span>
<span class="nc" id="L134">                logger.info(SPACE + &quot;###Implementation of &quot; + classUnderTestParameter + &quot; required###\n&quot;);</span>
<span class="nc" id="L135">            }</span>
        }
<span class="fc" id="L137">    }</span>
    
    /**
     * Sets the parameters.
     * 
     * @param packageTestVar
     *            the package test var
     * @param classUnderTestParameter
     *            the class under test parameter
     * @param testingClassParameter
     *            the testing class parameter
     * @param xmlFileName
     *            the xml file name
     * @param packageTest
     *            the package test
     */
    private void setParameters(String packageTestVar, String classUnderTestParameter, String testingClassParameter,
            String xmlFileName, String packageTest, boolean replaceSlash) {
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">        if (replaceSlash) {</span>
<span class="fc" id="L156">            testTransf.setTestPackage(JSXMUtils.replaceSlashWithDot(packageTestVar));</span>
        } else {
<span class="nc" id="L158">            testTransf.setTestPackage(packageTestVar);</span>
        }
<span class="fc" id="L160">        testTransf.setPath(packageTest);</span>
<span class="fc" id="L161">        testTransf.setClassUnderTest(classUnderTestParameter);</span>
<span class="fc" id="L162">        testTransf.setTestingClass(testingClassParameter);</span>
<span class="fc" id="L163">        testTransf.setXmlFileName(xmlFileName);</span>
<span class="fc" id="L164">    }</span>
    
    /**
     * Prepare external implementation.
     * External implementation convetion: The first import 
     * found in the specAdapter is the package that will
     * be used to place the JUnit tests.
     * 
     * @param compAdapterClass
     *            the comp adapter class
     * @param classUnderTestParameter
     *            the class under test parameter
     * @param testingClassParameter
     *            the testing class parameter
     * @param xmlFileName
     *            the xml file name
     * @param p
     *            the p
     */
    private void prepareExternalImplementation(String compAdapterClass, String classUnderTestParameter,
            String testingClassParameter, String xmlFileName, Specification p) {
<span class="nc" id="L185">        BufferedReader br = null;</span>
        try {
            try {
                String scan;
<span class="nc" id="L189">                br = new BufferedReader(new InputStreamReader(new FileInputStream(p.getTestAdaptersDirectory() + compAdapterClass), &quot;UTF8&quot;));</span>
               
<span class="nc" id="L191">                StringBuffer importsBUffer = new StringBuffer(); </span>
<span class="nc" id="L192">                boolean found=false;</span>
<span class="nc bnc" id="L193" title="All 4 branches missed.">                while ((scan = br.readLine()) != null &amp;&amp; !found) {</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">                    if (scan.startsWith(&quot;import&quot;)) {</span>
<span class="nc" id="L195">                        logger.debug(&quot;{} for {} &quot;, scan, compAdapterClass);</span>
<span class="nc" id="L196">                        importsBUffer.append(scan);</span>
<span class="nc" id="L197">                        found=true;</span>
                    }
                }
<span class="nc" id="L200">                final String imports = importsBUffer.toString();</span>
<span class="nc" id="L201">                logger.debug(&quot;{} Imports: {}&quot;,compAdapterClass,imports);</span>
<span class="nc" id="L202">                final String clearedString = imports.replace(&quot;import&quot;, &quot;&quot;).replace(&quot;;&quot;, &quot;&quot;).replace(&quot; &quot;, &quot;&quot;);</span>
<span class="nc" id="L203">                final String removablePart = clearedString.substring(clearedString.lastIndexOf('.') + 1);</span>
<span class="nc" id="L204">                logger.debug(&quot;cleared string: {},part to be removed: {}&quot;, clearedString, removablePart);</span>
<span class="nc" id="L205">                p.setPackageTest(&quot;jsxm.&quot; + clearedString.replace(removablePart, &quot;&quot;));</span>
                
<span class="nc" id="L207">                String specificationTestPackageDir = p.getJunitMavenTestPath()+ JSXMUtils.replaceDotWithSlash(p.getPackageTest());</span>
                
<span class="nc" id="L209">                List&lt;String&gt; directoryNames = new LinkedList&lt;String&gt;();</span>
<span class="nc" id="L210">                directoryNames.add(specificationTestPackageDir);</span>
<span class="nc" id="L211">                SxmFileUtils.makeDirectories(directoryNames);</span>

<span class="nc" id="L213">                String packageWithoutDot = p.getPackageTest();</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">                if (p.getPackageTest().endsWith(&quot;.&quot;)) {</span>
<span class="nc" id="L215">                    packageWithoutDot = p.getPackageTest().substring(0, p.getPackageTest().length() - 1);</span>
<span class="nc" id="L216">                    p.setPackageTest(packageWithoutDot);</span>
                }                
<span class="nc" id="L218">                logger.debug(&quot;\n{} \n{} \n{} \n{} \n{}&quot;, packageWithoutDot, classUnderTestParameter, testingClassParameter,</span>
                        xmlFileName, specificationTestPackageDir);
<span class="nc" id="L220">                setParameters(packageWithoutDot, classUnderTestParameter, testingClassParameter, xmlFileName,</span>
                        specificationTestPackageDir, false);
            }
            finally {
<span class="nc" id="L224">                br.close();    </span>
<span class="nc" id="L225">            }</span>
        }
<span class="nc" id="L227">        catch (IOException e) {</span>
<span class="nc" id="L228">            logger.error(&quot;Failed to read {} file&quot;, compAdapterClass);</span>
<span class="nc" id="L229">        }</span>
        
<span class="nc" id="L231">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.3.201306030806</span></div></body></html>